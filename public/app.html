<!DOCTYPE html>
<html>
<head>
  <title>Example</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  <link href="//fonts.googleapis.com/css?family=Monoton" rel="stylesheet" media>
  <link href="//fonts.googleapis.com/css?family=Montserrat" rel="stylesheet" media>
  <link href="//fonts.googleapis.com/css?family=Josefin+Sans" rel="stylesheet">
  <link href="//fonts.googleapis.com/css?family=Quicksand" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Cousine" rel="stylesheet">
  <link rel="stylesheet" media="screen" href="https://fontlibrary.org/face/office-code-pro" type="text/css"/>
  <link href="/stylesheets/footer.css" rel="stylesheet" type="text/css"/>
  <link href="/stylesheets/header.css" rel="stylesheet" type="text/css"/>
  <link href="/stylesheets/video.css" rel="stylesheet" type="text/css"/>

</head>
<body>
  <div class="contentContainer">
    <div class="video-background">
        <div class="video-foreground">
          <iframe id="backgroundvid" <iframe width="560" height="315" src="https://www.youtube.com/embed/videoseries?list=PLan6wuyGvGAlAAOQtSLcAy6ZL_YQ-sm0S&autoplay=1&loop=1" frameborder="0"  mute="1" allow="accelerometer; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>></iframe>
        </div>
      </div>
    <header class="header-container">
      <div class="Live">
        <div class="label-wrapper">
          <span>Live Now</span>
          <span class="circle"></span>
        </div>
      </div>
      <div class="StreamBar">
        <img class="playButton" src="http://simpleicon.com/wp-content/uploads/play1-64x64.png" alt="" width="32" height="32">
        <span>Channel 1: After Dark Selections w/ Toby</span>
        <span class="location">Dublin</span>

      </div>
      <div class="NowPlaying">
      <img class="playButton" src="http://simpleicon.com/wp-content/uploads/play1-64x64.png" alt="" width="32" height="32">
        <span>Channel 2: </span>
        <span class="songName">Totems </span>
        <span>w/ </span>
        <span class="artistName">Tweet </span>
        <span class="location">Lagos</span>
        <!--<img src="https://www.slantmagazine.com/wp-content/uploads/2005/03/itsmeagain.jpg" alt="" width="32" height="32">-->
      </div>
    </header>
    <!-- <div class="cloudContent">
    </div>-->
    <footer>
      <div id="player-container">
      <div id="play-button-container">
        <svg x="0px" y="0px" width="300px" height="300px" viewBox="0 0 300 300" fill="#fff">
          <defs>
            <path id="circlePath" d=" M 150, 150 m -60, 0 a 60,60 0 0,1 120,0 a 60,60 0 0,1 -120,0 "></path>
          </defs>
          <circle cx="100" cy="100" r="50" fill="none" stroke="none">
          </circle>
          <g>
            <use xlink:href="#circlePath" fill="none"></use>
            <text fill="red" stroke="#fff">
              <textPath xlink:href="#circlePath" fill="#fff"> BITTER â€¢ CASSAVA </textPath>
            </text>
          </g>
        </svg>
      </div>
    </div>
    </footer>
  </div>
</body>
<script src="/javascripts/TagCloud-master/dist/TagCloud.min.js"></script>
<script src="https://code.jquery.com/jquery-1.10.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
<script type="text/javascript">
  var myTags = [
    'Iceberg','Osondu','Ye','Ode To Bear','Junior June','Delta',"3am @ Toni's",
    'unseen freestyle', 'Adorn', 'Chicago Freestyle',"Don't Touch My Hair", "Incomplete Kisses",
    'Lay Me Down', 'Special Affair', 'Discipline', 'Warmth', 'Cab Ride', 'Good & Plenty',
    'Holding Hands In Public', 'John Redcorn', 'Fire & Desire', 'The Root', 'Soul Sista'
  ];

  var tagCloud = TagCloud('.cloudContent', myTags,{

    // radius in px
    radius: 900,

    // animation speed
    // slow, normal, fast
    maxSpeed: 'slow',
    initSpeed: 'slow',

    // 0 = top
    // 90 = left
    // 135 = right-bottom
    direction: 135,

    // interact with cursor move on mouse out
    keep: true

});
</script>

<script>


</script>
<script type="text/javascript">

  var socket = io();
  var uri;
  var deviceID;
  var isBroadcaster = false;

  // get hash parameters from the url
  function getHashParams() {
    var hashParams = {};
    var e, r = /([^&;=]+)=?([^&;]*)/g,
    q = window.location.hash.substring(1);
    while ( e = r.exec(q)) {
      hashParams[e[1]] = decodeURIComponent(e[2]);
    }
    return hashParams;
  }

  var params = getHashParams();
  var access_token = params.access_token;
  var refresh_token = params.refresh_token;
  var error = params.error;

  function refreshToken()
  {
    $.ajax({
      url: '/refresh_token',
      data: {
        'refresh_token': refresh_token
      }
    }).done(function(data) {
      access_token = data.access_token;
    });

  }

  setTimeout(refreshToken, 1000000);
  getUserDeviceInfo();
  getUser();

  socket.emit("hello", { message: "hello from client!" });

  socket.on("onGetMyName", function(data)
  {
    console.log("My Name: " + data.name);
  });

  socket.on("onSendMyNameToAllClients", function(data)
  {
    console.log("Name of another client: " + data.name);
  });

  socket.on("playSong", function(data)
  {
    if(isBroadcaster == false)
    {
      $.ajax({
        url: 'https://api.spotify.com/v1/me/player/play',
        contentType: 'application/json',
        type: 'PUT',
        dataType: 'json',
        headers: {
          'Authorization': 'Bearer ' + access_token
        },
        data: JSON.stringify({"uris":[data.uri], "device_id":deviceID, "offset": { "uri":data.uri} }),
        success: function(response) {
        }
      });
    }

  });

  socket.on("pauseSong", function(data)
  {
    if(isBroadcaster == false)
    {
      $.ajax({
        url: 'https://api.spotify.com/v1/me/player/pause',
        contentType: 'application/json',
        type: 'PUT',
        dataType: 'json',
        headers: {
          'Authorization': 'Bearer ' + access_token
        },
        data: JSON.stringify({"device_id":deviceID}),
        success: function(response) {
        }
      });
    }

  });

  socket.on("resumeSong", function(data)
  {
    if(isBroadcaster == false)
    {
      $.ajax({
        url: 'https://api.spotify.com/v1/me/player/play',
        contentType: 'application/json',
        type: 'PUT',
        dataType: 'json',
        headers: {
          'Authorization': 'Bearer ' + access_token
        },
        data: "",
        success: function(response) {
        }
      });
    }
  });



  function getBroadcastPlayback()
  {
    $.ajax({
      url: 'https://api.spotify.com/v1/me/player',
      headers: {
        'Authorization': 'Bearer ' + access_token
      },
      success: function(response) {
        console.log(response);

        playbackJson = {
          imgsrc: response.item.album.images[0].url,
          songName: response.item.name,
          artistName: response.item.artists[0].name,
          albumName: response.item.album.name,
          progress: response.progress_ms,
          songLength: response.timestamp,
          isPlaying: response.is_playing,
          uri: response.item.uri,
          deviceID: response.device.id,
          trackID: response.item.id
        }

        socket.emit("BroadcasterPlayback", playbackJson);

      }

    });
  }

  function updateJSON(jsonData)
  {
    $.ajax({
      data: JSON.stringify(jsonData),
      url: '/updateJSON',
      method: "POST",
      contentType: "application/json",
      dataType: 'json',
      success: function(response)
      {

      }
    });
  }

function getUser()
{
  $.ajax({
    url: 'https://api.spotify.com/v1/me',
    headers: {
      'Authorization': 'Bearer ' + access_token
    },
    success: function(response) {
      if (response.id === '96pcj22qe7b6uom5ifeia72vb')
      {
        isBroadcaster = true;
        setInterval(getBroadcastPlayback, 2000);
      }
      else
      {
        getUserDeviceInfo()
      }

    }
  });
}

function getUserDeviceInfo()
{
  $.ajax({
    url: 'https://api.spotify.com/v1/player',
    headers: {
      'Authorization': 'Bearer ' + access_token
    },
    success: function(response) {
      deviceID = response.device.id
    }
  });
}


  function sendMyNameToAllClients()
  {
    socket.emit("sendMyNameToAllClients");
  }

  sendMyNameToAllClients();
</script>
</html>
